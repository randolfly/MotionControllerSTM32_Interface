@page "/CommandUI"
@using MotionInterface.Lib.Model
@using MotionInterface.Lib.Service
@using MotionInterface.Lib.Util

@inject CommandCommunicationService CommandCommunicationService

<MContainer Fluid Class="fill-height">
<MRow Style="min-height:200px">
    <MCol Cols="12" Sm="6">
        <FramesList ShowFramesList="CommandCommunicationService.ReceivedProtocolFrameList"/>
    </MCol>
    <MCol Cols="12" Sm="6">
        <FramesList ShowFramesList="CommandCommunicationService.SendProtocolFrameList"/>
    </MCol>
</MRow>

<MRow NoGutters Style="margin-top: 10px;">
    <MCol Cols="1" Style="display: flex;justify-content:space-around">
        <MButton Icon Color="@_portStatusLed" OnClick="ToggleSerialPort">
            <MIcon>mdi-power</MIcon>
        </MButton>
    </MCol>
    <MCol Cols="4" Align="AlignTypes.Start">
        <MAutocomplete @bind-Value="ProtocolCommand"
                       Items="Enum.GetValues(typeof(ProtocolCommand))
                           .Cast<ProtocolCommand>().ToList()"
                       ItemText="r=>r.ToString()" 
                       ItemValue="r=>r"
                       Dense Solo
                       HideNoData HideSelected 
                       Placeholder="Start typing to Search" Label="Command"/>
    </MCol>
    <MCol Align="AlignTypes.Start">
        <MAutocomplete @bind-Value="ParamDataString"
                       Items="CommandCommunicationService.SendProtocolFrameList
                           .Select(p=>p.ParamData.ToFloatString()).ToList()"
                       ItemText="r=>r.ToString()"
                       ItemValue="r=>r" Dense Solo
            HideNoData HideSelected Placeholder="Start typing to Search" Label="Command"></MAutocomplete>
    </MCol>
    <MCol Cols="1" Style="display: flex;justify-content:space-around">
        <MButton Icon Color="indigo" OnClick="SendProtocolFrame">
            <MIcon>mdi-send</MIcon>
        </MButton>
    </MCol>

</MRow>
</MContainer>


@code {
    private ProtocolCommand _protocolCommand = new ();
    private ProtocolCommand ProtocolCommand
    {
        get
        {
            return _protocolCommand;
        }
        set
        {
            _protocolCommand = value;
            ProtocolFrame.Command = value;
        }
    }
    private ProtocolFrame ProtocolFrame { get; set; } = new();

    private string ParamDataString
    {
        get => ProtocolFrame.ParamData.ToFloatString();
        set => ProtocolFrame.ParamData = value.ToByteArray();
    }

    private string _portStatusLed = "red";

    protected override void OnInitialized()
    {
        base.OnInitialized();
        var invocationList = CommandCommunicationService.OnParseFrameDataAction?
            .GetInvocationList();
        if (invocationList == null || !invocationList.Contains(UpdateUiFrames))
        {
            CommandCommunicationService.OnParseFrameDataAction += UpdateUiFrames;
        }
    }

    private void UpdateUiFrames(ProtocolFrame protocolFrame)
    {
        // update received frames
        InvokeAsync(StateHasChanged);
    }


    private void SendProtocolFrame()
    {
        CommandCommunicationService.SendFrameData(ProtocolFrame);
        InvokeAsync(StateHasChanged);
    }

    private void ToggleSerialPort()
    {
        if (CommandCommunicationService.IsPortOpen)
        {
            CommandCommunicationService.ClosePort();
        }
        else
        {
            CommandCommunicationService.OpenPort();
        }
        UpdatePortStatusLed();
    }

    private void UpdatePortStatusLed()
    {
        _portStatusLed = CommandCommunicationService.IsPortOpen ? "green" : "red";
    }
}